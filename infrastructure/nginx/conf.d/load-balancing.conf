# ============================================================================
# Load Balancing Configuration for GremlinsAI Backend
# Advanced load balancing with health checks and session persistence
# ============================================================================

# ============================================================================
# Upstream Backend Servers
# ============================================================================
upstream gremlinsai_backend {
    # Load balancing method: least_conn (least connections)
    # Alternatives: round_robin (default), ip_hash, hash
    least_conn;

    # Backend servers with health check parameters
    server backend1:8000 max_fails=3 fail_timeout=30s weight=1;
    server backend2:8000 max_fails=3 fail_timeout=30s weight=1;
    
    # Backup server (only used if primary servers are down)
    # server backend3:8000 backup;

    # Keepalive connections for better performance
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# ============================================================================
# Upstream Worker Servers (for background tasks)
# ============================================================================
upstream gremlinsai_worker {
    server worker:8001 max_fails=2 fail_timeout=60s;
    keepalive 8;
}

# ============================================================================
# Health Check Configuration
# ============================================================================
# Note: nginx-plus has native health checks, for open-source nginx
# we use passive health checks based on max_fails and fail_timeout

# Active health check endpoint (requires nginx-plus or custom module)
# health_check interval=10s fails=3 passes=2 uri=/api/v1/health;

# ============================================================================
# Session Persistence (Sticky Sessions)
# ============================================================================
# Method 1: IP Hash (simple but not ideal for load balancers/proxies)
# upstream gremlinsai_backend {
#     ip_hash;
#     server backend1:8000;
#     server backend2:8000;
# }

# Method 2: Cookie-based (recommended)
# Requires nginx-sticky-module or nginx-plus
# sticky cookie srv_id expires=1h domain=.gremlinsai.com path=/;

# Method 3: JWT-based (application handles session)
# No nginx configuration needed, handled by application

# ============================================================================
# Connection Limits
# ============================================================================
# Limit concurrent connections per upstream server
# limit_conn_zone $server_name zone=backend_conn:10m;
# limit_conn backend_conn 100;

# ============================================================================
# Request Queue
# ============================================================================
# Queue requests when all backends are busy
# queue 100 timeout=30s;

# ============================================================================
# Slow Start (nginx-plus feature)
# ============================================================================
# Gradually increase traffic to newly added servers
# server backend1:8000 slow_start=30s;

# ============================================================================
# Load Balancing Monitoring
# ============================================================================
# Status page for monitoring upstream health
# location /nginx_status {
#     stub_status on;
#     access_log off;
#     allow 127.0.0.1;
#     deny all;
# }

# ============================================================================
# Failover Configuration
# ============================================================================
# Proxy settings for failover
proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
proxy_next_upstream_tries 2;
proxy_next_upstream_timeout 10s;

# ============================================================================
# Circuit Breaker Pattern
# ============================================================================
# Automatically remove failing servers from rotation
# max_fails: number of failed attempts before marking server as down
# fail_timeout: time to wait before retrying a failed server

# ============================================================================
# Geographic Load Balancing (nginx-plus)
# ============================================================================
# Route traffic based on client location
# geo $backend_pool {
#     default backend_us;
#     192.168.1.0/24 backend_eu;
#     10.0.0.0/8 backend_asia;
# }

# ============================================================================
# A/B Testing / Canary Deployment
# ============================================================================
# Split traffic between versions
# split_clients "${remote_addr}${http_user_agent}" $backend_pool {
#     10% backend_canary;
#     *   backend_stable;
# }

# ============================================================================
# Rate Limiting per Backend
# ============================================================================
limit_req_zone $binary_remote_addr zone=backend_limit:10m rate=100r/s;

# ============================================================================
# Upstream Keepalive Settings
# ============================================================================
# Reuse connections to upstream servers
proxy_http_version 1.1;
proxy_set_header Connection "";

